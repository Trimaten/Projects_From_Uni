<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

<!-- Full Width & Height -->
<div class="w-screen min-h-screen px-6 py-8 bg-gray-50">

  <div class="max-w-7xl mx-auto flex flex-col space-y-8">
    <!-- Header -->
    <div>
      <h1 class="text-5xl font-bold"><%= @workflow.title %></h1>
      <p class="text-xl text-gray-600">Owner: <%= @workflow.owner.username %></p>
      <p class="text-xl text-gray-600">Description: <%= @workflow.description %></p>
    <% if current_user == @workflow.owner %>
        <p class="text-xl text-gray-600">Visibility:</p>
        
        <%= form_with model: @workflow, url: workflow_path(@workflow), method: :patch, local: true, id: "visibility-form" do |form| %>
          <div class="flex items-center space-x-4">
            <div class="flex items-center">
              <label class="inline-flex items-center relative mx-8">
                <%= form.radio_button :public, true, class: "form-radio text-indigo-600" %>
                <span class="ml-2 text-gray-700">Public</span>
              </label>

              <label class="inline-flex items-center relative">
                <%= form.radio_button :public, false, class: "form-radio text-indigo-600" %>
                <span class="ml-2 text-gray-700">Private</span>
              </label>
            </div>
            <%= form.submit "Save Visibility", class: "hidden", id: "visibility-submit" %>
          </div>
        <% end %>





    <% else %>
      <p class="text-xl text-gray-600">
        Visibility:
        <span class="<%= @workflow.public? ? 'text-gray-600' : 'text-gray-600' %>">
          <%= @workflow.public? ? 'Public' : 'Private' %>
        </span>
      </p>
    <% end %>
    </div>



    <div class="mb-2 flex items-center justify-between">
      <div class="mb-0 mt-4">
        <h3 class="text-2xl font-semibold mb-6">Form for Current Stage</h3>
      </div>
      <div class="flex items-center space-x-3 text-sm">
        <%= form_with url: invite_participant_workflow_path(@workflow), method: :post, local: true, class: "flex space-x-2" do |f| %>
          <%= f.collection_select :user_id, User.where.not(id: @workflow.participants.pluck(:user_id)), :id, :username,
            { prompt: "Select user to invite" },
            { class: "border p-2 rounded-lg" } %>
          <%= f.submit "Invite", class: "bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm" %>
        <% end %>
        <div class="flex items-center space-x-2">
          <input id="invite-link" type="text"
            value="<%= accept_invite_workflow_url(@workflow) %>"
            readonly
            class="border px-2 py-1 rounded w-56 text-gray-700 text-sm" />
          <button onclick="copyInviteLink()"
            class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">
            Copy Link
          </button>
        </div>
      </div>
    </div>

    <div class="flex space-x-4 w-full">

      <%# FORM SECTION (LEFT COLUMN) - Shadow removed, border added %>
      <div class="flex-1 bg-white p-8 rounded-2xl relative border border-gray-300">
        <% if @stage.present? && @stage.form.present? %>
          <%= link_to 'Edit',
            edit_workflow_form_path(@workflow, @stage.form),
            class: 'absolute top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-full hover:bg-green-600' %>
          <div class="mt-8">
            <h2 class="text-2xl font-semibold mb-4"><%= @stage.form.title %></h2>
            <div class="space-y-6">
              <% @stage.form.form_fields.each do |field| %>
                <% type = field.typefield.to_s.downcase.strip %>
                <% allowed_types = %w[select checkbox radio] %>
                <% contents = begin
                  parsed = JSON.parse(field.content || "[]")
                  parsed.is_a?(Array) ? parsed : []
                rescue
                  field.content.to_s.split(",").map(&:strip).reject(&:blank?)
                end %>
                <% contents = [""] if contents.empty? && allowed_types.include?(type) %>

                <div class="mb-6">
                  <p class="font-semibold text-gray-700 mb-2 relative inline-block">
                    <%= field.title %>
                    <% if field.required %>
                      <span class="text-red-600 text-xl font-bold ml-1 cursor-pointer relative group">
                        *
                        <span
                          class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 whitespace-nowrap bg-black text-white text-xs rounded px-2 py-1 opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-opacity"
                          style="z-index: 10;"
                        >
                          Required
                        </span>
                      </span>
                    <% end %>
                  </p>

                  <% if allowed_types.include?(type) %>
                    <div class="space-y-2">
                      <% contents.each_with_index do |option, idx| %>
                        <% input_id = "field_#{field.id}_option_#{idx}" %>
                        <% if type == 'checkbox' %>
                          <div class="flex items-center space-x-2">
                            <input type="checkbox" disabled id="<%= input_id %>" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="text-gray-700"><%= option %></span>
                          </div>
                        <% elsif type == 'radio' %>
                          <div class="flex items-center space-x-2">
                            <input type="radio" disabled class="text-blue-600 focus:ring-blue-500 h-4 w-4 border-gray-300">
                            <span class="text-gray-700"><%= option %></span>
                          </div>
                        <% elsif type == 'select' && idx == 0 %>
                          <select class="preview mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-700 shadow-sm" aria-disabled="true">
                            <% contents.each do |opt| %>
                              <option><%= opt %></option>
                            <% end %>
                          </select>
                        <% end %>
                      <% end %>
                    </div>
                  <% else %>
                    <% if type == "textarea" %>
                      <div class="bg-gray-100 px-4 py-2 rounded text-gray-700 whitespace-pre-wrap"><%= field.content.presence || "—" %></div>
                    <% elsif type == "file" %>
                      <p class="text-gray-500 italic">[File upload field]</p>
                    <% else %>
                      <div class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-700 shadow-sm">
                        <%= field.content.presence || "—" %>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <div class="text-gray-500 italic">
            No form assigned to this stage.
          </div>
        <% end %>
      </div>

      <%# RIGHT SIDEBAR: STAGES - Shadow removed, border added %>
      <div class="w-96 bg-gray-100 p-6 rounded-2xl border border-gray-300 overflow-y-auto top-20 self-start ">
        <h3 class="text-xl font-semibold mb-4">Stages</h3>
        <ul class="space-y-4" id="stages-list">
          <% @workflow.stages.order(:position).each do |stage| %>
            <li>
              <div class="relative group">
                <%= form_with url: set_current_stage_workflow_path(@workflow), method: :patch, local: true do |form| %>
                  <%= hidden_field_tag :stage_id, stage.id %>
                  <%= form.submit stage.title,
                      class: "w-full text-left px-4 py-2 rounded-lg font-medium " +
                            (stage.id == @workflow.current_stage ? "bg-green-500 text-white" : "bg-white hover:bg-gray-200 text-gray-800") %>
                <% end %>

              <!-- Hover-Buttons -->
              <div class="absolute right-3 top-2 flex space-x-2 z-20">

                <!-- Edit Icon Button -->
                <%= link_to edit_workflow_stage_path(@workflow, stage),
                            title: "Edit Stage",
                            class: "p-1 rounded flex items-center justify-center transition-colors" do %>
                  <span class="material-symbols-outlined text-gray-700 w-5 h-5">edit</span>
                <% end %>
              </div>
            </div>
          </li>
        <% end %>
      </ul>

        <!-- Plus Button for Adding New Stage -->
        <%= form_with url: add_stage_workflow_path(@workflow), method: :post, local: true do |form| %>
          <%= form.submit '+ Add New Stage', class: 'mt-6 bg-green-500 text-white px-6 py-3 rounded-full hover:bg-green-600' %>
        <% end %>
      </div>
    </div>

    <div class="w-full flex justify-between mt-6 ">
      <%= form_with url: workflow_path(@workflow), method: :delete, local: true, id: "delete-workflow-form", html: { role: "none" } do %>
        <button
          id="open-delete-workflow-modal-btn"
          type="button"
          class="bg-red-500 text-white px-6 py-3 rounded-full hover:bg-red-600"
        >
          Delete Workflow
        </button>
      <% end %>
      <div class="flex space-x-4">
        <%= link_to 'Cancel', dashboard_path, class: 'bg-gray-300 text-gray-800 px-6 py-3 rounded-full hover:bg-gray-400' %>
        <button
          type="button"
          id="save-workflow-button"
          class="bg-blue-500 text-white px-6 py-3 rounded-full hover:bg-blue-600"
        >
          Save Workflow
        </button>
      </div>
    </div>

    <div id="confirm-delete-workflow-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-[9999]">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full text-center">
        <p class="mb-6 text-gray-800 text-lg font-semibold">
          Are you sure you want to delete this workflow? This action cannot be undone.
        </p>
        <div class="flex justify-center gap-4">
          <button id="cancel-delete-workflow-btn" class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100">
            Cancel
          </button>
          <button id="confirm-delete-workflow-btn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">
            Delete Workflow
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("turbo:load", () => {
      const workflowModal = document.getElementById("confirm-delete-workflow-modal");
      const openWorkflowBtn = document.getElementById("open-delete-workflow-modal-btn");
      const cancelWorkflowBtn = document.getElementById("cancel-delete-workflow-btn");
      const confirmWorkflowBtn = document.getElementById("confirm-delete-workflow-btn");
      const deleteWorkflowForm = document.getElementById("delete-workflow-form");

      if (openWorkflowBtn && workflowModal && cancelWorkflowBtn && confirmWorkflowBtn && deleteWorkflowForm) {
        openWorkflowBtn.addEventListener("click", () => {
          workflowModal.classList.remove("hidden");
        });

        cancelWorkflowBtn.addEventListener("click", () => {
          workflowModal.classList.add("hidden");
        });

        confirmWorkflowBtn.addEventListener("click", () => {
          deleteWorkflowForm.submit();
        });
      }

      document.querySelectorAll('select.preview').forEach(sel => {
        sel.addEventListener('change', e => e.preventDefault());
      });

      function copyInviteLink() {
        const input = document.getElementById("invite-link");
        input.select();
        document.execCommand("copy");
        alert("Link copied to clipboard!");
      }
    });

      document.querySelectorAll('select.preview').forEach(sel => {
    sel.addEventListener('change', e => e.preventDefault());
  });
  function copyInviteLink() {
    const input = document.getElementById("invite-link");
    input.select();
    document.execCommand("copy");
    alert("Link copied to clipboard!");
  }



    document.addEventListener("turbo:load", () => {
        const saveWorkflowBtn = document.getElementById("save-workflow-button");
        const visibilityForm = document.getElementById("visibility-form");

        if (saveWorkflowBtn && visibilityForm) {
            saveWorkflowBtn.addEventListener("click", () => {
                visibilityForm.submit();
            });
        }
    });



    function toggleTooltip(id) {
        const tooltip = document.getElementById(id);
        const currentlyVisible = !tooltip.classList.contains('hidden');

        document.querySelectorAll('[id^="tooltip-"]').forEach(el => {
            el.classList.add('hidden');
        });

        if (!currentlyVisible) {
            tooltip.classList.remove('hidden');
        }
    }

    document.addEventListener('click', function (event) {
        if (!event.target.closest('button') && !event.target.closest('[id^="tooltip-"]')) {
            document.querySelectorAll('[id^="tooltip-"]').forEach(el => {
                el.classList.add('hidden');
            });
        }
    });
  </script>
</div>
